server.on("/list", HTTP_GET, [](AsyncWebServerRequest *request) {
    String output = "<html><body>";
    File root = SD_MMC.open("/");
    File file = root.openNextFile();

    while(file) {
        String filename = file.name();
        output += "<a href=\"/photo?name=" + filename + "\">" + filename + "</a><br>";
        file = root.openNextFile();
    }
    
    output += "</body></html>";
    request->send(200, "text/html", output);
});

server.on("/photo", HTTP_GET, [](AsyncWebServerRequest *request) {
    if(request->hasArg("name")) {
        String filename = request->arg("name");
        File file = SD_MMC.open(filename);
        if(file) {
            AsyncWebServerResponse *response = request->beginResponseStream("image/jpeg");
            response->addHeader("Content-Disposition", "inline; filename=\"" + filename + "\"");
            response->addHeader("Connection", "close");
            response->setContentLength(file.size());

            uint8_t buf[512];
            while(file.available()) {
                size_t s = file.read(buf, 512);
                response->write(buf, s);
            }
            request->send(response);
            file.close();
        } else {
            request->send(404, "text/plain", "File not found");
        }
    } else {
        request->send(400, "text/plain", "Bad request");
    }
});

output += "<a href=\"/photo?name=" + filename + "\">" + filename + "</a> [<a href=\"/download?name=" + filename + "\">Download</a>]<br>";

server.on("/download", HTTP_GET, [](AsyncWebServerRequest *request) {
    if(request->hasArg("name")) {
        String filename = request->arg("name");
        File file = SD_MMC.open(filename);
        if(file) {
            AsyncWebServerResponse *response = request->beginResponseStream("image/jpeg");
            response->addHeader("Content-Disposition", "attachment; filename=\"" + filename + "\"");
            response->addHeader("Connection", "close");
            response->setContentLength(file.size());

            uint8_t buf[512];
            while(file.available()) {
                size_t s = file.read(buf, 512);
                response->write(buf, s);
            }
            request->send(response);
            file.close();
        } else {
            request->send(404, "text/plain", "File not found");
        }
    } else {
        request->send(400, "text/plain", "Bad request");
    }
});
