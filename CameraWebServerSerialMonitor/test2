// ... (Your existing code)

void handleListImages(AsyncWebServerRequest *request) {
    String html = "<html><body><ul>";

    File root = SD_MMC.open("/");
    if (root) {
        File file = root.openNextFile();
        while (file) {
            String fileName = file.name();
            if (fileName.endsWith(".jpg") || fileName.endsWith(".jpeg")) {
                html += "<li><a href='/view?name=" + fileName + "'>Image " + fileName + "</a><img data-src='/view?name=" + fileName + "' class='lazy-load' width='100' height='75'></li>";
            }
            file = root.openNextFile();
        }
    }
    html += "</ul><br/><a href='/'>Back to main page</a></body></html>";

    request->send(200, "text/html", html);
}

// ... (Your existing code)

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var lazyImages = document.querySelectorAll('.lazy-load');

        var lazyLoad = function () {
            lazyImages.forEach(function (image) {
                if (image.getBoundingClientRect().top <= window.innerHeight && image.getBoundingClientRect().bottom >= 0 && getComputedStyle(image).display !== 'none') {
                    image.src = image.dataset.src;
                    image.classList.remove('lazy-load');
                }
            });

            lazyImages = Array.prototype.filter.call(lazyImages, function (image) {
                return image.classList.contains('lazy-load');
            });
        };

        if ('IntersectionObserver' in window) {
            var lazyImageObserver = new IntersectionObserver(function (entries, observer) {
                entries.forEach(function (entry) {
                    if (entry.isIntersecting) {
                        var lazyImage = entry.target;
                        lazyImage.src = lazyImage.dataset.src;
                        lazyImage.classList.remove('lazy-load');
                        lazyImageObserver.unobserve(lazyImage);
                    }
                });
            });

            lazyImages.forEach(function (lazyImage) {
                lazyImageObserver.observe(lazyImage);
            });
        } else {
            lazyLoad();
        }

        if ('addEventListener' in window) {
            window.addEventListener('scroll', lazyLoad);
            window.addEventListener('resize', lazyLoad);
        } else if ('attachEvent' in window) {
            window.attachEvent('onscroll', lazyLoad);
            window.attachEvent('onresize', lazyLoad);
        }
    });
</script>
