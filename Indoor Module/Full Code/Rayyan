#include <WiFiManager.h> 
#include <WiFi.h>
#include "ESPAsyncWebServer.h"
#include <SensirionI2CSen5x.h>
#include <SensirionI2CScd4x.h>
#include <Wire.h>
#include <time.h>

WiFiManager wm;

String serialBuffer = "";
SensirionI2CSen5x sen5x;
SensirionI2CScd4x scd4x;

const char *soft_ap_ssid = "IndoorModule2";
const char *soft_ap_password = "testpassword";

AsyncWebServer server(80);

float massConcentrationPm1p0;
float massConcentrationPm2p5;
float massConcentrationPm4p0;
float massConcentrationPm10p0;
float ambientHumidity;
float ambientTemperature;
float vocIndex;
float noxIndex;
uint16_t co2;

void printAndBuffer(String message, bool newline=true) {
  if (newline) {
    Serial.println(message);
    serialBuffer += message + "\n";
  } else {
    Serial.print(message);
    serialBuffer += message;
  }

  while (serialBuffer.length() > 2000) {  // Adjust the size as necessary
    int nextLineBreak = serialBuffer.indexOf('\n') + 1;
    if (nextLineBreak > 0) {
      serialBuffer = serialBuffer.substring(nextLineBreak);
    } else {
      serialBuffer = serialBuffer.substring(100);  // Default trimming
    }
  }
}

void appendToBuffer(char c) {
  serialBuffer += c;
  if (serialBuffer.length() > 2000) {
    serialBuffer = "";  // Clear buffer when size limit is reached
  }
}

String readScdCo2() {
  uint16_t c;
  float t;
  float h;

  scd4x.readMeasurement(c, t, h);

  if (c != 0) {
    co2 = c;
  }

  return String(co2);
}

String readPm1p0() {
  sen5x.readMeasuredValues(
    massConcentrationPm1p0, massConcentrationPm2p5, massConcentrationPm4p0,
    massConcentrationPm10p0, ambientHumidity, ambientTemperature, vocIndex,
    noxIndex);

  return String(massConcentrationPm1p0);
}

String readPm2p5() {
  sen5x.readMeasuredValues(
    massConcentrationPm1p0, massConcentrationPm2p5, massConcentrationPm4p0,
    massConcentrationPm10p0, ambientHumidity, ambientTemperature, vocIndex,
    noxIndex);

  return String(massConcentrationPm2p5);
}

String readPm4p0() {
  sen5x.readMeasuredValues(
    massConcentrationPm1p0, massConcentrationPm2p5, massConcentrationPm4p0,
    massConcentrationPm10p0, ambientHumidity, ambientTemperature, vocIndex,
    noxIndex);

  return String(massConcentrationPm4p0);
}

String readPm10p0() {
  sen5x.readMeasuredValues(
    massConcentrationPm1p0, massConcentrationPm2p5, massConcentrationPm4p0,
    massConcentrationPm10p0, ambientHumidity, ambientTemperature, vocIndex,
    noxIndex);

  return String(massConcentrationPm10p0);
}

String readAmbientHumidity() {
  sen5x.readMeasuredValues(
    massConcentrationPm1p0, massConcentrationPm2p5, massConcentrationPm4p0,
    massConcentrationPm10p0, ambientHumidity, ambientTemperature, vocIndex,
    noxIndex);

  return String(ambientHumidity);
}

String readAmbientTemperature() {
  sen5x.readMeasuredValues(
    massConcentrationPm1p0, massConcentrationPm2p5, massConcentrationPm4p0,
    massConcentrationPm10p0, ambientHumidity, ambientTemperature, vocIndex,
    noxIndex);

  return String(ambientTemperature);
}

String readVocIndex() {
  sen5x.readMeasuredValues(
    massConcentrationPm1p0, massConcentrationPm2p5, massConcentrationPm4p0,
    massConcentrationPm10p0, ambientHumidity, ambientTemperature, vocIndex,
    noxIndex);

  return String(vocIndex);
}

String readNoxIndex() {
  sen5x.readMeasuredValues(
    massConcentrationPm1p0, massConcentrationPm2p5, massConcentrationPm4p0,
    massConcentrationPm10p0, ambientHumidity, ambientTemperature, vocIndex,
    noxIndex);

  return String(noxIndex);
}

const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE HTML><html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://kit.fontawesome.com/d91e44f906.js" crossorigin="anonymous"></script>
  <style>
    html {
     font-family: Arial;
     display: inline-block;
     margin: 0px auto;
     text-align: center;
    }
    h2 { font-size: 3.0rem; }
    p { font-size: 3.0rem; }
    .units { font-size: 1.2rem; }
    .dht-labels{
      font-size: 1.5rem;
      vertical-align:middle;
      padding-bottom: 15px;
    }
  </style>
</head>
<body>
  <h2>ESP32 Air Quality Server</h2>
  <p>
    <i class="fas fa-smog" style="color:#000000;"></i> 
    <span class="dht-labels">PM 1.0</span>
    <span id="pm1p0">%PM1P0%</span>
    <sup class="units">ug/m3</sup>
  </p>
  <p>
    <i class="fas fa-smog" style="color:#a0a0a0;"></i>
    <span class="dht-labels">PM 2.5</span>
    <span id="pm2p5">%PM2P5%</span>
    <sup class="units">ug/m3</sup>
  </p>
  <p>
    <i class="fas fa-smog" style="color:#afafaf;"></i>
    <span class="dht-labels">PM 4.0</span>
    <span id="pm4p0">%PM4P0%</span>
    <sup class="units">ug/m3</sup>
  </p>
  <p>
    <i class="fas fa-smog" style="color:#f0f0f0;"></i> 
    <span class="dht-labels">PM 10.0</span>
    <span id="pm10p0">%PM10P0%</span>
    <sup class="units">ug/m3</sup>
  </p>
  <p>
    <i class="fas fa-project-diagram" style="color:#631fc4;"></i> 
    <span class="dht-labels">Carbon Dioxide</span>
    <span id="co2">%CO2%</span>
    <sup class="units">ppm</sup>
  </p>
  <p>
    <i class="fas fa-tint" style="color:#00add6;"></i> 
    <span class="dht-labels">Ambient Humidity</span>
    <span id="ambienthumidity">%AMBIENTHUMIDITY%</span>
    <sup class="units">&percnt;</sup>
  </p>
  <p>
    <i class="fas fa-thermometer-half" style="color:#f1c40f;"></i>
    <span class="dht-labels">Ambient Temperature</span>
    <span id="ambienttemperature">%AMBIENTTEMPERATURE%</span>
    <sup class="units">&deg;C</sup>
  </p>
  <p>
    <i class="fas fa-leaf" style="color:#00e024;"></i>
    <span class="dht-labels">VOC Index</span>
    <span id="vocindex">%VOCINDEX%</span>
    <sup class="units"></sup>
  </p>
  <p>
    <i class="fas fa-leaf" style="color:#b3e6b3;"></i>
    <span class="dht-labels">NOx Index</span>
    <span id="noxindex">%NOXINDEX%</span>
    <sup class="units"></sup>
  </p>
  <p>
    <i class="fas fa-wifi" style="color:#007bff;"></i> 
    <span class="dht-labels">WiFi Manager</span>
    <button onclick="triggerWiFiManager()">Configure WiFi</button>
  </p>
  <p>
    <i class="fas fa-terminal" style="color:#44bd32;"></i> 
    <span class="dht-labels">Serial Output</span>
    <span id="serial">%SERIAL%</span>
  </p>
</body>
<script>
function triggerWiFiManager() {
  var xhttp = new XMLHttpRequest();
  xhttp.open("GET", "/wifi", true);
  xhttp.send();
  alert("WiFi Manager is triggered. Connect to the AP to configure.");
}

setInterval(function ( ) {
  getData();
}, 10000);

void getData() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("pm1p0").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/pm1p0", true);
  xhttp.send();
  
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("pm2p5").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/pm2p5", true);
  xhttp.send();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("pm4p0").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/pm4p0", true);
  xhttp.send();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("pm10p0").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/pm10p0", true);
  xhttp.send();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("co2").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/co2", true);
  xhttp.send();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("ambienthumidity").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/ambienthumidity", true);
  xhttp.send();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("ambienttemperature").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/ambienttemperature", true);
  xhttp.send();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("vocindex").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/vocindex", true);
  xhttp.send();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("noxindex").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/noxindex", true);
  xhttp.send();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("serial").innerHTML = this.responseText;
    }
  };
  xhttp.open("GET", "/serial", true);
  xhttp.send();
}
</script>
</html>)rawliteral";

String processor(const String& var){
  if(var == "PM1P0"){
    return readPm1p0();
  }
  else if(var == "PM2P5"){
    return readPm2p5();
  }
  else if(var == "PM4P0"){
    return readPm4p0();
  }
  else if(var == "PM10P0"){
    return readPm10p0();
  }
  else if(var == "CO2"){
    return readScdCo2();
  }
  else if(var == "AMBIENTHUMIDITY"){
    return readAmbientHumidity();
  }
  else if(var == "AMBIENTTEMPERATURE"){
    return readAmbientTemperature();
  }
  else if(var == "VOCINDEX"){
    return readVocIndex();
  }
  else if(var == "NOXINDEX"){
    return readNoxIndex();
  }
  else if(var == "SERIAL"){
    return serialBuffer;
  }
  return String();
}

void setup(){
  WiFi.mode(WIFI_AP_STA);
  Serial.begin(115200);

  printAndBuffer("To connect to the WiFi network, follow these steps:");
  printAndBuffer("1. Open your device's WiFi settings.");
  printAndBuffer("2. Look for a network named 'AutoConnectAP'.");
  printAndBuffer("3. Connect to 'AutoConnectAP'. If it's password-protected, use 'password' as the password.");
  printAndBuffer("4. Wait until your device indicates that it has connected to the network.");
  printAndBuffer("5. Once connected, enter the following address in a web browser: http://192.168.1.218/");



 // Start WiFi Manager
    bool res = wm.autoConnect("AutoConnectAP","password");
    if(!res) {
        Serial.println("Failed to connect");
    } else {
        Serial.println("Connected");
    }

  WiFi.softAP(soft_ap_ssid, soft_ap_password);
  printAndBuffer("ESP32 IP as soft AP: ");
  printAndBuffer(WiFi.softAPIP().toString());
  printAndBuffer("Local network server:");
  printAndBuffer("http://", false);
  printAndBuffer(WiFi.localIP().toString());

  Wire.begin();
  sen5x.begin(Wire);
  sen5x.deviceReset();
  sen5x.setTemperatureOffsetSimple(0.00);
  sen5x.startMeasurement();
  delay(1000);
  scd4x.begin(Wire);
  scd4x.startPeriodicMeasurement();

  server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/html", index_html, processor);
      return;
    }
  });

  server.on("/wifi", HTTP_GET, [](AsyncWebServerRequest *request){
    printAndBuffer("Triggering WiFi Manager");
    request->send(200, "text/plain", "WiFi Manager is triggered. Connect to the AP to configure.");
    wm.startConfigPortal("AutoConnectAP", "password");
  });

  server.on("/pm1p0", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readPm1p0().c_str());
      return;
    }
  });

  server.on("/pm2p5", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readPm2p5().c_str());
      return;
    }
  });

  server.on("/pm4p0", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readPm4p0().c_str());
      return;
    }
  });

  server.on("/pm10p0", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readPm10p0().c_str());
      return;
    }
  });

  server.on("/co2", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readScdCo2().c_str());
      return;
    }
  });

  server.on("/ambienthumidity", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readAmbientHumidity().c_str());
      return;
    }
  });

  server.on("/ambienttemperature", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readAmbientTemperature().c_str());
      return;
    }
  });

  server.on("/vocindex", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readVocIndex().c_str());
      return;
    }
  });

  server.on("/noxindex", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", readNoxIndex().c_str());
      return;
    }
  });

  server.on("/serial", HTTP_GET, [](AsyncWebServerRequest *request){
    if (ON_STA_FILTER(request) || ON_AP_FILTER(request)) {
      request->send_P(200, "text/plain", serialBuffer.c_str());
      return;
    }
  });

  server.begin();
}

void loop(){
}
